<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="x5-fullscreen" content="true">
    <meta name="full-screen" content="yes">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>可口可乐</title>
    <link rel="stylesheet" href="../../css/plugins/loading.css">
    <link rel="stylesheet" href="../../css/plugins/weui.min.css">
    <link rel="stylesheet" href="userInfo.css">
    <script type="text/javascript" src="../../js/plugins/jquery-2.1.4.min.js"></script>
    <script type="text/javascript" src="../../js/plugins/vue.min.js"></script>
    <!--    <script type="text/javascript" src="../../js/plugins/fastclick.js"></script> -->
    <script type="text/javascript" src="../../js/plugins/jweixin-1.2.0.js"></script>
    <script type="text/javascript" src="../../js/plugins/md5.min.js"></script>
    <script type="text/javascript" src="../../js/plugins/jsencrypt.min.js"></script>
    <script type="text/javascript" src="../../js/plugins/weui.min.js"></script>
    <script type="text/javascript" src="../../js/zexUtility.js"></script>
    <script type="text/javascript" src="../../js/zexService.js"></script>
    <script type="text/javascript" src="../../js/wxConfig.js"></script>
    <script type="text/javascript" src="../../js/zexApis.js"></script>
    <!--    <script type="text/javascript" src="../../js/DMP_S_zexApis.js"></script> -->
</head>

<body id="container" class="page_bg">

    <div id="page_loading" class="page-loading">
        <div class="page-loading-control">
            <div class="rect1"></div>
            <div class="rect2"></div>
            <div class="rect3"></div>
            <div class="rect4"></div>
            <div class="rect5"></div>
        </div>
    </div>


    <div class="page_bg">
        <img :src="page.background_img" alt="" />
    </div>


    <div class="input_wrap">

        <div class="name_box">
            <div class="name_title">收货人姓名:</div>
            <input class="name_input" id="input" type="text" v-model="input_req.realName" placeholder="请输入收货人姓名" />
        </div>


        <div class="phone_box">
            <div class="phone_text"> 手机号码:</div>

            <input class="phone_input" id="inputTwo" type="tel" v-model="input_req.mobile" placeholder="请输入手机号码" maxlength="11" />
            <div class="phoneButton_box">
                <button class="get_check_code" @click="getPhoneCode()" :disabled="time_num < 60" v-text="get_code_txt">
			</div>
		</div>


		<div class="name_box">
			<div class="name_title">验证码:</div>
			<input class="name_input" id="inputThree" type="text" v-model="input_req.sms_verify_code" placeholder="请输入验证码" maxlength="6" />
		</div>


		<div class="addr_box">
			<div class="addr_title">收货地址:</div>
			<textarea class="addr_input" cols="2" id="inputFour" rows="2" v-model="input_req.address" placeholder="请输入收货地址"></textarea>
		</div>

	</div>

	<div class="next" @click="next()">
		<img :src="page.commit_btn_img" alt="" />
	</div>

	</div>
</body>
<script>
	document.addEventListener('touchstart', function() {});

	// $(function() {FastClick.attach(document.body);});
	// $(".input_wrap").css("min-height",document.body.clientHeight + "px");



	new Vue({
		el: "#container",
		data: function() {
			return {
				loading: true,
				page: {
										commit_btn_img: "../../images/userInfoButton.png",
										background_img: "../../images/userInfoBg.jpg",
				},
				base_info: {},
				input_req: {
					realName: "",
					mobile: "",
					address: "",
					city: "",
					sms_verify_code: ""
				},
				res_form_fields: [], //需要验证的表单
				time_num: 60,
				get_code_txt: "获取验证码",
				res_check_sms_code: null,
				code_img: "",
				notice_desc_color: "#333",
				notice_text_color: "#333",
				rotate_result: {},
				next_isDisable: false,
				is_check2: false,
				draw_type: "ticket_draw",
				urlParams: {},
			};

		},

		created: function() {

			// this.base_info = JSON.parse(window.sessionStorage.getItem("base_info")) || {};

			// this.urlParams = JSON.parse(window.sessionStorage.getItem("urlParams")) || {};

			// this.getTnitUser();

			// this.loading = false;


		},

		methods: {

			// 初始化填写信息页面
			getTnitUser: function() {
				var req = {
					open_id: this.urlParams.open_id,
					promotion_id: this.urlParams.promotion_id,
					timestamp: zexUtil.getTimestamp()
				};
				zexApis.getTnitUser(req).done((function(res) {

					if (res.code == '200' && res.promotion_id) {
						//成公关闭loading页面
						setTimeout(function() {
							$('#page_loading').css('display', 'none');
						}, 500);
						this.page = res.page;
						console.log(JSON.stringify(res));
						this.page_bg = res.page.background_img;
					}
				}).bind(this));

			},

			// 获取手机验证码
			getPhoneCode: function() {
				if (!zexUtil.isMobile(this.input_req.mobile)) {
					this.alertInfo("提示", "请输入正确的手机号码哦~", "好的", false);
					return;
				}
				var req = {
					open_id: this.urlParams.open_id,
					promotion_id: this.urlParams.promotion_id,
					phoneNum: this.input_req.mobile,
					timestamp: zexUtil.getTimestamp()
				};
				this.get_code_txt = "正在发送";
				// 获取短信验证码接口
				zexApis.getverificationcode(req).done((function(res) {
					if (res.code == 200) {
						weui.toast('发送成功', {
							duration: 2000,
							className: 'font-14'
						});
						this.res_check_sms_code = res.verificationCode;
						// 倒数
						this.time_num = 59;
						this.get_code_txt = this.time_num + " s";
						var setInter = setInterval((function() {
							this.time_num--;
							this.get_code_txt = this.time_num + " s";
							if (this.time_num === 0) {
								this.time_num = 60;
								this.get_code_txt = "获取验证码";
								clearInterval(setInter);
							}
						}).bind(this), 1000);
					} else if (res.code == 40018) {
						this.alertInfo('提示', '短信发送失败，请再试一下...', '好的呢', false);
						this.time_num = 60;
						this.get_code_txt = "获取验证码";
					} else if (res.code == 40016) {
						this.alertInfo('提示', '短信发送失败，请再试一下...', '好的呢', false);
						this.get_code_txt = "获取验证码";
					} else {
						this.get_code_txt = "获取验证码";
					}
				}).bind(this));
			},

			next: function() {

				var self = this;

				if (!this.input_req.realName.trim()) {
					this.alertInfo('提示', '请输入收货人姓名...', '好的呢', false);
					return;
				}

				if (!this.input_req.mobile.trim()) {
					this.alertInfo('提示', '请输入手机号...', '好的呢', false);
					return;
				}
				if (!zexUtil.isMobile(this.input_req.mobile.trim())) {
					this.alertInfo('提示', '请输入正确的手机号码哦...', '好的呢', false);
					return;
				}
				if (!this.input_req.sms_verify_code.trim()) {
					this.alertInfo('提示', '请输入短信验证码哦...', '好的呢', false);
					return;
				}

				if (!this.input_req.address.trim()) {
					this.alertInfo('提示', '请输入收货地址...', '好的呢', false);
					return;
				}


				window.sessionStorage.setItem('mobile', this.input_req.mobile.trim());

				//	var ticket_pic_id = null != window.sessionStorage.getItem("ticket_pic_id") ? window.sessionStorage.getItem("ticket_pic_id") : null != zexUtil.GetQueryString("ticket_pic_id") ? zexUtil.GetQueryString("ticket_pic_id") : "";
				//	var verify_code = window.sessionStorage.getItem('duijiangma') != null ? window.sessionStorage.getItem('duijiangma') : '';
				//	var draw_type = (null != ticket_pic_id && ticket_pic_id != '') ? "ticket_draw" : "code_draw";


				var req = {
					open_id: this.urlParams.open_id,
					promotion_id: this.urlParams.promotion_id,
					realName: this.input_req.realName,
					address: this.input_req.address,
					mobile: this.input_req.mobile.trim(),
					sms_verify_code: this.input_req.sms_verify_code,
					timestamp: zexUtil.getTimestamp(),
					prize_level_ids: window.sessionStorage.getItem('prize_level_ids'),
					ticket_pic_id: window.sessionStorage.getItem("ticket_pic_id"),
					prize_verify_code: "",
					draw_type: "ticket_draw",
				};

				self.loading = true;

				zexApis.saveUserInformation(req).done((function(res) {
					setTimeout((function() {

						self.loading = false;

						if (res.code == 200 || res.code == '200') {
							self.toastInfo('提交成功', 2000);
							window.location.href =
								"../result/result.html";

						} else if (res.code == 10002 || res.code == '10002') {

							self.alertInfo('提示', '该手机号码已参加过活动！', '好的呢', true);

						} else if (res.code == 4029) {
							self.alertInfo('提示', '信息已提交过啦，请勿重复提交哦~ ', '好的呢', true);
						} else if (res.code == 4001) {
							self.alertInfo('提示', '哎呀... 网络有点繁忙 ~', '好的呢', false);
						} else if (res.code == 40014) {
							self.alertInfo('提示', '重复点击啦~ 再慢点...', '好的呢', false);
						} else if (res.code == 4034) {
							self.alertInfo('提示', '短信验证码不正确哦，再检查检查...', '好的呢',
								false);
						} else {
							self.alertInfo('提示', res.code + ' 服务器有点繁忙哦~ 请稍后再试试看...',
								'好的呢', false);
						}
					}).bind(this), 1000);

				}).bind(this)).always((function(status) {
					if (status.statusText == 'timeout') {
						self.alertInfo('提示', 'timeout 服务器有点繁忙哦~ 请稍后再试试看...', '好的呢', false);
					}
				}).bind(this));


				var reqParams = {
					open_id: this.urlParams.open_id,
					operator_type: 'writeUserInfo',
					note: this.urlParams.promotion_id,
					source: this.urlParams.scene
				};

				zexApis.promotionLog(reqParams).done(function() {});

			},

			// weUI Alert => clickBtn -> closeWindow()
			alertInfo: function(title, content, btnTxt, isCloseWindow) {
				weui.alert(content, {
					title: title,
					buttons: [{
						label: btnTxt,
						type: 'primary',
						onClick: (function() {
							if (isCloseWindow) {
								this.closeWindow()
							}
						}).bind(this)
					}]
				});
			},

			// weUI toast => clickBtn -> closeWindow()
			toastInfo: function(content, duration, isCloseWindow) {
				weui.toast(content, {
					duration: duration,
					className: 'font-14',
					callback: (function() {
						if (isCloseWindow) {
							this.closeWindow()
						}
					}).bind(this)
				});
			},

			// wx SDK closeWindow
			closeWindow: function() {
				wx.closeWindow();
			}

		}
	});

	window.onload = function() {

		document.getElementById('input').addEventListener('blur', function() {
			window.scrollTo(0, 0) //页面滚动到顶部
		}, false)

		document.getElementById('inputTwo').addEventListener('blur', function() {
			window.scrollTo(0, 0) //页面滚动到顶部
		}, false)

		document.getElementById('inputThree').addEventListener('blur', function() {
			window.scrollTo(0, 0) //页面滚动到顶部
		}, false)

		document.getElementById('inputFour').addEventListener('blur', function() {
			window.scrollTo(0, 0) //页面滚动到顶部
		}, false)

	}

</script>

</html>