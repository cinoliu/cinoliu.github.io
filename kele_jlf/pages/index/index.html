<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="x5-fullscreen" content="true">
	<meta name="full-screen" content="yes">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
	<meta http-equiv="cache-control" content="max-age=0" />
	<meta http-equiv="cache-control" content="no-cache" />
	<meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
	<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
	<meta http-equiv="Pragma" content="no-cache" />
	<meta http-equiv="Expires" content="0" />
	<title>可口可乐</title>
	<link rel="stylesheet" href="index.css">
	<link rel="stylesheet" href="../../css/plugins/loading.css">
	<script type="text/javascript" src="../../js/plugins/jquery-2.1.4.min.js"></script>
	<script type="text/javascript" src="../../js/plugins/jweixin-1.2.0.js"></script>
	<script type="text/javascript" src="../../js/plugins/md5.min.js"></script>
	<script type="text/javascript" src="../../js/plugins/vue.min.js"></script>
	<script type="text/javascript" src="../../js/plugins/hammer.min.js"></script>
	<script type="text/javascript" src="../../js/plugins/vue-touch.min.js"></script>
	<script type="text/javascript" src="../../js/plugins/jsencrypt.min.js"></script>
	<script type="text/javascript" src="../../js/zexUtility.js"></script>
	<script type="text/javascript" src="../../js/zexService.js"></script>
	<script type="text/javascript" src="../../js/wxConfig.js"></script>
	<script type="text/javascript" src="../../js/zexApis.js"></script>
	<link rel="stylesheet" href="https://res.wx.qq.com/open/libs/weui/1.1.2/weui.min.css">
	<script type="text/javascript" src="https://res.wx.qq.com/open/libs/weuijs/1.1.3/weui.min.js"></script>

	<style>
		.act_huodong_wrap {
			width: 100%;
			margin: 0 auto;
			/*border: 1px solid #000;*/
			text-align: center;
		}


		.huodong_wrap {
			width: 100%;
			height: 100%;
			position: fixed;
			z-index: 101;
			display: -webkit-flex;
			align-items: center;
			-webkit-align-items: center;
			justify-content: center;
			-webkit-justify-content: center;
			flex-direction: column-reverse;
			-webkit-flex-direction: column-reverse;
		}


		.huodong_container {
			width: 90%;
			height: 90%;
		}

		.huodong_content {
			width: 100%;
			height: 100%;
			border-radius: .6rem;
		}


		.huodong_content_img {
			width: 100%;
			height: 90%;
			overflow-y: auto;
			font-size: 1.4rem;
			-webkit-overflow-scrolling: touch;
			border-radius: .6rem;
		}

	</style>
</head>
<style>

</style>

<body id="container" class="page_bg">

	<div id="page_loading" class="page-loading">
		<div class="page-loading-control">
			<div class="rect1"></div>
			<div class="rect2"></div>
			<div class="rect3"></div>
			<div class="rect4"></div>
			<div class="rect5"></div>
		</div>
	</div>

	<div class="page_box">

		<img class="bg_img" v-bind:src="page_info.background_img">

		<div class="next_btn" @click="next()" v-show="!course_show">
			<img :src="page_info.upload_btn_img2" alt="" @click="next()" />
		</div>

		<div class="next_text" @click="course_show=true" v-show="!course_show">
			<span @click="course_show=true"> 活动规则</span>
		</div>

		<div class="next_time" v-show="!course_show" :style="{color: page_info.camp_desc_color}">
			<span style=" color: #fff;font-size: 1.4rem"> 兑换时间: 2020年7月24日-2020年8月6日</span>
		</div>

	</div>


	<div class="act_huodong_wrap" v-show="course_show">
		<div class="weui-mask" style="z-index: 100;"></div>
		<div class="huodong_wrap">
			<div class="huodong_container">
				<div class="huodong_content">
					<div class="huodong_content_img">
						<img :src="page_info.camp_desc_img" alt="" />
					</div>
					<img src="../../images/cuo.png" alt="" v-touch:tap="course_show = !course_show" style="padding-top: 10%; width: 10%;margin: auto" />
				</div>
			</div>
		</div>
	</div>

</body>

</html>
<script>
	//成公关闭loading页面
	setTimeout(function() {
		$('#page_loading').css('display', 'none');
	}, 500);

	function closewin() {
		wx.closeWindow();
	};

	var container = new Vue({
		el: '#container',

		data: {
			loading: true,
			course_show: false,
			page_info: {
				//				upload_btn_img2: "../../images/indexButton.png",
				//				background_img: "../../images/indexBg.jpg",
				//				camp_desc_img: "../../images/hdsm.jpg",
			},

			promotionBaseInfo: {},
			promotion_id: "",
	
			urlParams: {},

		},

		created: function() {


			this.urlParams = {
				component_appid: zexUtil.GetQueryString("component_appid"),
				appid: zexUtil.GetQueryString("appid"),
				open_id: zexService.getOpenId() ,
				promotion_id: zexUtil.GetQueryString("promotion_id"),
				scene: zexUtil.GetQueryString("scene"),
				actid: zexUtil.GetQueryString("actid"),
				coupon_stock_id: zexUtil.GetQueryString('coupon_stock_id'),
				brand_id: zexUtil.GetQueryString('brand_id') ,

			};

			window.sessionStorage.setItem("urlParams", JSON.stringify(this.urlParams));
			this.getTicketImg();
			var reqParams = {
				open_id: this.urlParams.open_id,
				operator_type: 'login',
				note: this.urlParams.promotion_id,
				source: this.urlParams.scene,

			};
			zexApis.promotionLog(reqParams).done(function(response) {});
		},

		methods: {


			getTicketImg() {

				var self = this;
				var reqParams = {
					open_id: this.urlParams.open_id,
					promotion_id: this.urlParams.promotion_id,
					timestamp: zexUtil.getTimestamp(),
				};



				zexApis.statInformation(reqParams).done(function(response) {
					self.loading = false;
					if (response.code == '200') {
						//成公关闭loading页面
						setTimeout(function() {
							$('#page_loading').css('display', 'none');
						}, 500);

						self.page_info = response.page;
						self.promotionBaseInfo = response.promotionBaseInfo;
						self.promotion_id = response.promotion_id;

						self.promotionBaseInfo.start_date = self.promotionBaseInfo.start_date.substring(0, 10);

						self.promotionBaseInfo.end_date = self.promotionBaseInfo.end_date.substring(0, 10);
						// 存储基本信息
						window.sessionStorage.setItem("base_info", JSON.stringify(self.promotionBaseInfo));
						// 存储页面信息
						window.sessionStorage.setItem("page_info", JSON.stringify(self.page_info));

						var jsonUserFlowStr = JSON.parse(response.jsonUserFlowStr);

						if (null != jsonUserFlowStr) {
							window.sessionStorage.setItem('ticket_pic_id',
								jsonUserFlowStr.ticket_pic_id);
							window.sessionStorage.setItem('prize_level_ids',
								jsonUserFlowStr.prize_level_ids);
							window.sessionStorage.setItem('duijiangma',
								jsonUserFlowStr.verify_code);
							window.sessionStorage.setItem('public_draw',
								jsonUserFlowStr.draw_type);
							window.sessionStorage.setItem('prize_texts',
								jsonUserFlowStr.prize_texts);

							var user_flow = JSON.parse(response.jsonUserFlowStr) || {};
							// 存储上次上传成功返回的小票ID
							window.sessionStorage.setItem("ticket_pic_id", user_flow.ticket_pic_id);
							var awards_result = {
								prize_level_ids: user_flow.prize_level_ids || "",
								prize_texts: user_flow.prize_texts || ""
							};

							console.log(user_flow.next_page)
							
							switch (user_flow.next_page) {
						
								case "receive_receive_page":
									window.sessionStorage.setItem("awards_result", JSON.stringify(awards_result));
									
								window.sessionStorage.setItem("prize_level_ids", awards_result.prize_level_ids);
								window.sessionStorage.setItem("prize_texts", awards_result.prize_texts);
									
									window.sessionStorage.setItem("verify_code", user_flow.verify_code);
									//     window.location.href = "../awards/awards.html";
									window.location.href = "../rewardPrize/rewardPrize.html";
									break;
								case "fill_userinfo_page":
									window.sessionStorage.setItem("awards_result", JSON.stringify(awards_result));
									window.sessionStorage.setItem("verify_code", user_flow.verify_code);
									window.location.href = "../userInfo/userInfo.html";
									break;
								default:
									break;
							}


						}


					} else if (response.code == '4019') {
						self.alertInfo("提示", "促销活动不存在", "我知道了", true);
						return;
					} else if (response.code == '4014') {
						self.alertInfo("提示", "活动未开始", "我知道了", true);
						return;
					} else if (response.code == '4015') {
						self.alertInfo("提示", "活动已结束", "我知道了", true);
						return;
					} else if (response.code == '4017') {
						self.alertInfo("提示", "活动暂停", "我知道了", true);
						return;
					} else if (response.code == '4018') {
						self.alertInfo("提示", "活动下架", "我知道了", true);
						return;
					} else if (response.code == '4035') {
						self.alertInfo("提示", "活动未上线", "我知道了", true);
						return;
					} else if (response.code == '4016') {
						self.alertInfo("提示", "用户抽奖次数超过限制", "我知道了", true);
						return;
					} else if (response.code == '499') {
						self.alertInfo("提示", "网络不好,请重试", "我知道了", true);
						return;
					} else if (response.code == '4001') {
						self.alertInfo("提示", "网络不好,请重试", "我知道了", true);
						return;
					} else if (response.code == '4003') {
						self.alertInfo("提示", "网络不好,请重试", "我知道了", true);
						return;
					} else if (response.code == '4004') {
						self.alertInfo("提示", "网络不好,请重试", "我知道了", true);
						return;
					}
				}).always(function(status) {
					if (status.statusText == 'timeout') {
						self.alertInfo("提示", "网络不好,请重试", "我知道了", true);
					};
				});

			},

			next: function() {

				window.location.href = "../uploadTicket/uploadTicket.html";

			},

			// weUI Alert => clickBtn -> closeWindow()
			alertInfo: function(title, content, btnTxt, isCloseWindow) {
				weui.alert(content, {
					title: title,
					buttons: [{
						label: btnTxt,
						type: 'primary',
						onClick: (function() {
							if (isCloseWindow) {
								this.closeWindow()
							}
						}).bind(this)
					}]
				});
			},

			// wx SDK clickWindow
			closeWindow: function() {
				wx.closeWindow();
			},



		}
	})

</script>
