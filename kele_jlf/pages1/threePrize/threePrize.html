<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="x5-fullscreen" content="true">
	<meta name="full-screen" content="yes">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
	<meta http-equiv="cache-control" content="max-age=0" />
	<meta http-equiv="cache-control" content="no-cache" />
	<meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
	<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
	<meta http-equiv="Pragma" content="no-cache" />
	<meta http-equiv="Expires" content="0" />
	<title>可口可乐</title>

	<link rel="stylesheet" href="threePrize.css">
	<link rel="stylesheet" href="../../css/plugins/loading.css">
	<script type="text/javascript" src="../../js/plugins/jquery-2.1.4.min.js"></script>
	<script type="text/javascript" src="../../js/plugins/jweixin-1.2.0.js"></script>
	<script type="text/javascript" src="../../js/plugins/md5.min.js"></script>
	<script type="text/javascript" src="../../js/plugins/vue.min.js"></script>
	<script type="text/javascript" src="../../js/plugins/hammer.min.js"></script>
	<script type="text/javascript" src="../../js/plugins/vue-touch.min.js"></script>
	<script type="text/javascript" src="../../js/plugins/jsencrypt.min.js"></script>
	<script type="text/javascript" src="../../js/zexUtility.js"></script>
	<script type="text/javascript" src="../../js/zexService.js"></script>
	<script type="text/javascript" src="../../js/wxConfig.js"></script>
	<script type="text/javascript" src="../../js/zexApis.js"></script>
	<link rel="stylesheet" href="https://res.wx.qq.com/open/libs/weui/1.1.2/weui.min.css">
	<script type="text/javascript" src="https://res.wx.qq.com/open/libs/weuijs/1.1.3/weui.min.js"></script>
	<style>
		.act_huodong_wrap {
			width: 100%;
			margin: 0 auto;
			/*border: 1px solid #000;*/
			text-align: center;
		}


		.huodong_wrap {
			width: 100%;
			height: 100%;
			position: fixed;
			z-index: 101;
			display: -webkit-flex;
			align-items: center;
			-webkit-align-items: center;
			justify-content: center;
			-webkit-justify-content: center;
			flex-direction: column-reverse;
			-webkit-flex-direction: column-reverse;
		}


		.huodong_container {
			width: 90%;
			height: 70%;
		}

		.huodong_content {
			width: 100%;
			height: 100%;
			border-radius: .6rem;
		}


		.huodong_content_img {
			width: 85%;
			height: 72%;
			font-size: 1.4rem;
			-webkit-overflow-scrolling: touch;
			border-radius: .6rem;
			margin-left: 7.5%;

		}

		.huodong_button {
			z-index: 999;
			margin-top: -32%;
			width: 50%;
			margin-left: calc((100% - 50%)/2);
			padding-top: 10%;
		}

	</style>
</head>
</head>

<body id="container" class="page_bg">
	<div id="page_loading" class="page-loading">
		<div class="page-loading-control">
			<div class="rect1"></div>
			<div class="rect2"></div>
			<div class="rect3"></div>
			<div class="rect4"></div>
			<div class="rect5"></div>
		</div>
	</div>




	<div class="page_box">

		<img class="bg_img" v-bind:src="page_info.receive_bg">

		<div class="next_btn" @click="course_show=true">
			<img :src="page_info.not_wining_btn_img" alt="" />
		</div>

	</div>



	<div class="act_huodong_wrap" v-show="course_show">
		<div class="weui-mask" style="z-index: 100;"></div>
		<div class="huodong_wrap">
			<div class="huodong_container">
				<div class="huodong_content">
					<div class="huodong_content_img">

						<img src="../../images/zj/threeCG.png" alt="" />

						<!--						<img src="../../images/zj/threeSB.png" alt="" />-->

						<img src="../../images/zj/threeButton3.png" class="huodong_button" @click="course_show=false">

					</div>

					<img src="../../images/cuo.png" alt="" v-touch:tap="course_show = !course_show" style="width: 10%;margin: auto" />
				</div>
			</div>
		</div>
	</div>


	</div>
</body>
<script>
	if (history && history.pushState) {
		history.pushState({
			title: document.title,
			url: location.href
		}, document.title, location.href);
	}
	//添加退弹事件
	window.addEventListener("popstate", function(e) {
		// alert("我监听到了浏览器的返回按钮事件啦1"); 
		location.href = 'rewardPrize.html'; //在这里指定其返回的地址
	});

	var container = new Vue({
		el: "#container",
		data: function() {
			return {
				loading: true,
				act_rule_show: false,
				page_info: {
					receive_bg: "../../images/zj/sdjbg.jpg",
					wining_btn_img: "../../images//zj/ZJButton.png", // 按钮图
					not_wining_btn_img: "../../images/zj/threeButton2.png",
					prize_img: "",

				},

				base_info: {},
				is_prize: "3",
				referrer_check: false,
				checkCodeImg: "",
				one_click: false,
				actid: "", //  活动卡券id
				prize_level_ids: "",
				course_show: false,

			};
		},
		created: function() {

			this.loading = false;

			setTimeout(function() {
				$('#page_loading').css('display', 'none');
			}, 500);


			//	        zexWxConfig.runConfig(function () {
			//				_this.getPageInfo();
			//		
			//				_this.page_info = JSON.parse(window.sessionStorage.getItem("prizeInfo")) || {}; 
			//
			//				_this.loading = false;	
			//									
			//			});			
			//
			//			this.prize_level_ids = window.sessionStorage.getItem("prize_level_ids") || "";
			//			this.prize_texts = window.sessionStorage.getItem("prize_texts") || "";
			//			this.prize_code = window.sessionStorage.getItem("prize_code") || "";
			//			
			//			// this.prize_code = "4025";
			//			if( this.prize_texts == "获得【 “24包”·小托特】1个的中奖资格" ){
			//				this.prize_texts = "获得【 “24包”·小托特】<br/>1个的中奖资格"
			//			}
			//			
			//			if( this.prize_code == "4025"){
			//				this.noPrize = true;
			//				this.prize_texts = "本次您未能获得奖品<br>祝您下次好运!";
			//			}
			//			// this.actid = window.sessionStorage.getItem("actid") || "";
			//
			//			// 日志
			//			var logReq = {};
			//			logReq.open_id = zexService.getOpenId();				
			//			logReq.operator_type = 'winning';
			//			logReq.source = urlParams.scene;
			//			if( this.prize_code == "4025"){
			//				logReq.note = "未中奖";
			//			}else{
			//				logReq.note = window.sessionStorage.getItem("prize_texts");				
			//			}
			//			zexApis.promotionLog(logReq).done(function () {});		

		},
		methods: {

			//页面初始化
			getPageInfo: function() {
				var that = this;
				var reqParams = {
					open_id: zexService.getOpenId(),
					promotion_id: urlParams.promotion_id,
					ticket_pic_id: window.sessionStorage.getItem("ticket_pic_id"),
					timestamp: zexUtil.getTimestamp()
				};
				zexApis.getAdverpage(reqParams).done(function(response) {
					console.log(JSON.stringify(response));
					if (response.code == '200' && response.promotion_id) {
						//成公关闭loading页面
						setTimeout(function() {
							$('#page_loading').css('display', 'none');
						}, 500);
						// that.luckyDraw();
						that.page_if = response;
						// that.advert_bg = response.page.advert_background_img;
						that.receive_bg = response.page.receive_background_img;
						that.wining_success_text = response.page.wining_success_text;
						that.wining_btn_img = response.page.wining_btn_img;
						that.not_wining_btn_img = response.page.not_wining_btn_img;
						that.not_wining_fail_text = response.page.not_wining_fail_text;
						var jsonUserFlowStr;
						if (response.jsonUserFlowStr) {
							jsonUserFlowStr = JSON.parse(response.jsonUserFlowStr);
						};

						if (null != jsonUserFlowStr) {
							var next_page = jsonUserFlowStr.next_page;
							if (next_page == 'receive_receive_page') {

								window.sessionStorage.setItem('nextPage', next_page);
								window.sessionStorage.setItem('prize_level_ids', jsonUserFlowStr.prize_level_ids); //存储中奖等级ID
								window.sessionStorage.setItem('shake_text', jsonUserFlowStr.prize_texts);

								window.sessionStorage.setItem('ticket_pic_id', jsonUserFlowStr.ticket_pic_id);

							} else if (next_page == 'fill_userinfo_page') {

								window.sessionStorage.setItem('ticket_pic_id', jsonUserFlowStr.ticket_pic_id);
								window.sessionStorage.setItem('prize_level_ids', jsonUserFlowStr.prize_level_ids);
								window.sessionStorage.setItem('duijiangma', jsonUserFlowStr.verify_code);
								window.sessionStorage.setItem('public_draw', jsonUserFlowStr.draw_type);
								window.sessionStorage.setItem('shake_text', jsonUserFlowStr.prize_texts);
								window.sessionStorage.setItem('draw_check_priority', jsonUserFlowStr.draw_check_priority);
								window.location.href = '../form/form.html';

							}
						}

					} else if (response.code == '4001') {
						that.alertInfo("提示", "网络不好,请重试", "我知道了", true);
						return;
					} else if (response.code == '4003') {
						that.alertInfo("提示", "网络不好,请重试", "我知道了", true);
						return;
					} else if (response.code == '4004') {
						that.alertInfo("提示", "网络不好,请重试", "我知道了", true);
						return;
					} else if (response.code == '4019') {
						that.alertInfo("提示", "促销活动不存在", "我知道了", true);
						return;
					} else if (response.code == '4014') {
						that.alertInfo("提示", "活动未开始", "我知道了", true);
						return;
					} else if (response.code == '4015') {
						that.alertInfo("提示", "活动已结束", "我知道了", true);
						return;
					} else if (response.code == '4017') {
						that.alertInfo("提示", "活动暂停", "我知道了", true);
						return;
					} else if (response.code == '4018') {
						that.alertInfo("提示", "活动已下架", "我知道了", true);
						return;
					} else if (response.code == '4035') {
						that.alertInfo("提示", "活动未上线", "我知道了", true);
						return;
					} else if (response.code == '499') {
						//成公关闭loading页面
						setTimeout(function() {
							that.alertInfo("提示", "促销活动不存在", "我知道了", true);
						}, 500);
						return;
					}
				})
			},

			// 领取卡券				
			addCard: function() {


				var self = this;
				var reqParams = {
					component_appid: urlParams.component_appid,
					appid: urlParams.appid,
					actId: this.actid,
					outer_str: "cola_costa_wxcard",
					timestamp: zexUtil.getTimestamp()
				};
				// self.is_loading = true;
				console.log("请求参数", JSON.stringify(reqParams));
				zexApis.batchAddWxCard(reqParams).done((function(resJson) {
					console.log("接口返回", resJson);
					if (resJson.code == 200) {
						var cardList = resJson.cardList;
						$.each(cardList, function(i, card) {
							card.cardExt = JSON.stringify(card.cardExt);
						});

						var delReq = {
							promotion_id: urlParams.promotion_id,
							// draw_type: "ticket_draw",
							// ticket_pic_id: window.sessionStorage.getItem("ticket_pic_id"),
							draw_type: "code_draw",
							verify_code: window.sessionStorage.getItem('duijiangma') || "",
							open_id: zexService.getOpenId(),
							timestamp: zexUtil.getTimestamp(),
							// verify_code: window.sessionStorage.getItem('duijiangma') || "",		
						}


						wx.addCard({
							cardList: cardList, // 需要添加的卡券列表
							success: function(res) {
								console.log('success=>', JSON.stringify(res));
								// self.alertInfo("提示", '请至 " 我-卡包-我的票券 " 查看', "我知道了", true);													

								zexApis.delUserPromotionProduce(delReq).done((function(delRes) {
									if (delRes.code == "200" || delRes.code == 200) {
										// wx.closeWindow();
										self.alertInfo("提示", '请至 " 我-卡包-我的票券 " 查看', "我知道了", true);
									} else {
										this.alertInfo("提示", "系统繁忙   -" + delRes.code, "我知道了", false);
									}
								}).bind(this));
							},
							cancel: function(res) {
								console.log('cancel=>', JSON.stringify(res));
								self.one_click = false;
								// alert(JSON.stringify(res));							
							},
							fail: function(res) {
								console.log('fail=>', JSON.stringify(res));
								// alert(JSON.stringify(res));								
							},
							complete: function(res) {
								console.log('complete=>', JSON.stringify(res));
								self.one_click = false;
								// self.alertInfo("提示", '请至 " 我-卡包-我的票券2 " 查看', "我知道了", true);											
							}
						});

					} else if (resJson.code == 4003) {
						this.alertInfo("提示", "活动未开始或已下架  -" + reqParams.actId, "我知道了", true);
					} else {
						this.alertInfo("提示", "系统繁忙   -" + resJson.code, "我知道了", false);
					}
				}).bind(this));
			},

			// weUI Alert => clickBtn -> closeWindow()
			alertInfo: function(title, content, btnTxt, isCloseWindow) {
				weui.alert(content, {
					title: title,
					buttons: [{
						label: btnTxt,
						type: 'primary',
						onClick: (function() {
							if (isCloseWindow) {
								this.closeWindow()
							}
						}).bind(this)
					}]
				});
			},

			// wx SDK clickWindow
			closeWindow: function() {
				wx.closeWindow();
			},
		},
	});

</script>

</html>
