<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="x5-fullscreen" content="true">
	<meta name="full-screen" content="yes">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
	<meta http-equiv="cache-control" content="max-age=0" />
	<meta http-equiv="cache-control" content="no-cache" />
	<meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
	<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
	<meta http-equiv="Pragma" content="no-cache" />
	<meta http-equiv="Expires" content="0" />
	<title>可口可乐</title>
	<link rel="stylesheet" href="../../css/plugins/loading.css">
	<link rel="stylesheet" href="../../css/plugins/weui.min.css">
	<link rel="stylesheet" href="uploadTicket.css">
	<script type="text/javascript" src="../../js/plugins/jquery-2.1.4.min.js"></script>
	<script type="text/javascript" src="../../js/plugins/vue.min.js"></script>
	<!--    <script type="text/javascript" src="../../js/plugins/fastclick.js"></script> -->
	<script type="text/javascript" src="../../js/plugins/jweixin-1.2.0.js"></script>
	<script type="text/javascript" src="../../js/plugins/md5.min.js"></script>
	<script type="text/javascript" src="../../js/plugins/jsencrypt.min.js"></script>
	<script type="text/javascript" src="../../js/plugins/weui.min.js"></script>
	<script type="text/javascript" src="../../js/zexUtility.js"></script>
	<script type="text/javascript" src="../../js/zexService.js"></script>
	<script type="text/javascript" src="../../js/wxConfig.js"></script>
	<script type="text/javascript" src="../../js/zexApis.js"></script>
</head>

<body>
	<div id="container">
		<div class="page-loading" v-show="loading">
			<div class="page-loading-control">
				<div class="rect1"></div>
				<div class="rect2"></div>
				<div class="rect3"></div>
				<div class="rect4"></div>
			</div>
		</div>

		<div class="page_bg">
			<img :src="page.course_img" alt="" />
		</div>

		<div class="next_btn" @click="uploadTicketImg()">
			<img src="../../images/uploadTicketButton.png" alt="" />
		</div>

	</div>
</body>
<script>
	document.addEventListener('touchstart', function() {});
	// $(function() {FastClick.attach(document.body);});


	new Vue({
		el: "#container",
		data: function() {
			return {
				loading: true,
				course_show: false,
				page: {
					course_img: "../../images/uploadTicketBG.jpg",
				},
				base_info: {},
				money_selected: "", //选择小票金额
				shop_selected: "", //选择卖场:{},
				urlParams: {},
			};
		},

		created: function() {
			this.base_info = JSON.parse(window.sessionStorage.getItem("base_info")) || {};
			this.urlParams = JSON.parse(window.sessionStorage.getItem("urlParams")) || {};
			this.loading = false,
				zexWxConfig.runConfig(function() {});
			this.upReceipts();
		},


		methods: {


			// 获取选择小票下拉数据源
			upReceipts: function() {
				var req = {
					open_id: this.urlParams.open_id,
					promotion_id: this.urlParams.promotion_id,
					timestamp: zexUtil.getTimestamp()
				};
				zexApis.upReceipts(req).done((function(res) {
					this.loading = false;

					if (res.code == 200) {
						this.page = res.page;

					}
				}).bind(this));
			},


			// 通过微信SDK上传图片接口，获取图像的ServerID。
			uploadTicketImg: function() {
				var self = this;
				var photo_album = {
					count: 1, // 默认9
					sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
					sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
					success: function(res) {
						if (res.localIds[0]) {
							wx.uploadImage({
								localId: res.localIds[0], // 需要上传的图片的本地ID，由chooseImage接口获得
								isShowProgressTips: 0, // 默认为1，显示进度提示
								success: function(res) {
									if (res.serverId) {
										var serverId = res.serverId;
										self.uploadReceiptsIMG(serverId);
									}
									// 返回图片的服务器端ID
								},
								fail: function(res) {

									self.alertInfo("提示", "哎呀..服务器有点繁忙~ " + res.code, "我知道了");
								}
							});
						}
					},

				};


				wx.chooseImage(photo_album);

			},


			// 上传小票
			// 上传小票
			uploadTicketImg: function() {


				var sourceType = [];
				if (this.page.is_select_photo_album == 1) {
					sourceType.push('camera'); // 拍照上传
				}
				if (this.page.is_select_photo_album == 2) {
					sourceType.push('album'); // 选择相册
				}
				if (this.page.is_select_photo_album == 3) {
					sourceType.push('camera'); // 拍照上传
					sourceType.push('album'); // 选择相册
				}
				// 通过wx SDK获取serverId成功后调用上传小票接口
				this.getServerImageID(sourceType, (function(serverId) {
					var loading = weui.loading('小票上传中...', {
						className: 'font-14'
					});
					var req = {
						component_appid: this.urlParams.component_appid,
						appid: this.urlParams.appid,
						open_id: this.urlParams.open_id,
						promotion_id: this.urlParams.promotion_id,
						mediaId: serverId,
						shop_id: this.shop_selected,
						promotion_level_id: this.money_selected,
						timestamp: zexUtil.getTimestamp(),
						draw_check_priority: this.base_info.draw_check_priority,
						source: this.urlParams.scene
					};

					zexApis.uploadReceipts(req).done((function(res) {
						loading.hide();
						if (res.code == 200) {
							// 保存上传成功后返回的小票ID
							window.sessionStorage.setItem("ticket_pic_id", res.ticket_pic_id);

							var drawPrizeLevelReq = {
								open_id: this.urlParams.open_id,
								promotion_id: this.urlParams.promotion_id,
								draw_type: "ticket_draw",
								ticket_pic_id: res.ticket_pic_id,
								timestamp: zexUtil.getTimestamp(),
							};

							zexApis.getLuckyDraw(drawPrizeLevelReq).done((function(drawPrizeLevelRes) {
								// alert( JSON.stringify(drawPrizeLevelRes) );

								if (drawPrizeLevelRes.code == "200") {

									var receivePrizeLevelReq = {
										open_id: this.urlParams.open_id,
										promotion_id: this.urlParams.promotion_id,
										prize_level_ids: drawPrizeLevelRes.prize_level_ids,
										draw_type: "ticket_draw",
										ticket_pic_id: res.ticket_pic_id,
										timestamp: zexUtil.getTimestamp(),
									};

									window.sessionStorage.setItem("prize_level_ids", drawPrizeLevelRes.prize_level_ids);
									window.sessionStorage.setItem("prize_texts", drawPrizeLevelRes.prize_texts);

									window.location.href = '../rewardPrize/rewardPrize.html';

								}
							}).bind(this));


						} else if (res.code == 4031) {
							this.alertInfo("提示", "您上传次数超过限制啦~", "我知道了", true);
						} else {
							this.alertInfo("提示", "哎呀..服务器有点繁忙~ " + res.code, "我知道了");
						}

					}).bind(this));

				}).bind(this));
			},

			// weUI Alert => clickBtn -> closeWindow()
			alertInfo: function(title, content, btnTxt, isCloseWindow) {
				weui.alert(content, {
					title: title,
					buttons: [{
						label: btnTxt,
						type: 'primary',
						onClick: (function() {
							if (isCloseWindow) {
								this.closeWindow()
							}
						}).bind(this)
					}]
				});
			},

			// wx SDK clickWindow
			closeWindow: function() {
				wx.closeWindow();
			}

		}
	});

</script>

</html>
